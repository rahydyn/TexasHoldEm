<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./css/style.css" />
    <script src="./js/jquery-2.1.3.min.js"></script>
    <script src="./js/judgement.js"></script>
    <title>TH</title>
  </head>
  <body>
    <header>
      <div id="header"><span>ヘッダー</span></div>
    </header>
    <div id="container">
      <div id="cpu" class="player">
        <div class="hand">
          <div class="card card_cpu card_cpu_1">
            <div class="card_front">
              <img src="./img/cards/back.png" alt="" class="cpu_img_1" />
            </div>
            <div class="card_back">
              <img src="" alt class="cpu_img_1" />
            </div>
          </div>
          <div class="card card_cpu card_cpu_2">
            <div class="card_front">
              <img src="./img/cards/back.png" alt="" class="cpu_img_2" />
            </div>
            <div class="card_back">
              <img src="" alt class="cpu_img_2" />
            </div>
          </div>
        </div>
      </div>
      <div id="com_card" class="player">
        <div class="hand">
          <div class="card card_frop card_com_1">
            <div class="card_front">
              <img src="./img/cards/back.png" alt="" class="com_img_1" />
            </div>
            <div class="card_back">
              <img src="" alt="" class="com_img_1" />
            </div>
          </div>
          <div class="card card_frop card_com_2">
            <div class="card_front">
              <img src="./img/cards/back.png" alt="" class="com_img_2" />
            </div>
            <div class="card_back">
              <img src="" alt="" class="com_img_2" />
            </div>
          </div>
          <div class="card card_frop card_com_3">
            <div class="card_front">
              <img src="./img/cards/back.png" alt="" class="com_img_3" />
            </div>
            <div class="card_back">
              <img src="" alt="" class="com_img_3" />
            </div>
          </div>
          <div class="card card_turn card_com_4">
            <div class="card_front">
              <img src="./img/cards/back.png" alt="" class="com_img_4" />
            </div>
            <div class="card_back">
              <img src="" alt="" class="com_img_4" />
            </div>
          </div>
          <div class="card card_river card_com_5">
            <div class="card_front">
              <img src="./img/cards/back.png" alt="" class="com_img_5" />
            </div>
            <div class="card_back">
              <img src="" alt="" class="com_img_5" />
            </div>
          </div>
        </div>
      </div>
      <div id="you" class="player">
        <div class="hand">
          <div id="chart">
            <div>
              <input type="button" value="Close" id="chart-btn" />
            </div>
            <div id="chart_block">
              <ul id="chart_list">
                <li class="strength chart_list_title">役一覧</li>
                <li class="strength" id="SF">Straight Flush</li>
                <li class="strength" id="FK">Four-of-a-Kind</li>
                <li class="strength" id="FH">Full House</li>
                <li class="strength" id="FL">Flush</li>
                <li class="strength" id="SR">Straight</li>
                <li class="strength" id="TK">Three-of-a-Kind</li>
                <li class="strength" id="TP">Two-Pair</li>
                <li class="strength" id="OP">One-Pair</li>
              </ul>
              <ul id="your_history">
                <li class="history chart_list_title">You</li>
                <li class="history" id="SF_you"></li>
                <li class="history" id="FK_you"></li>
                <li class="history" id="FH_you"></li>
                <li class="history" id="FL_you"></li>
                <li class="history" id="SR_you"></li>
                <li class="history" id="TK_you"></li>
                <li class="history" id="TP_you"></li>
                <li class="history" id="OP_you"></li>
              </ul>
              <ul id="cpu_history">
                <li class="history chart_list_title">Rival</li>
                <li class="history" id="SF_cpu"></li>
                <li class="history" id="FK_cpu"></li>
                <li class="history" id="FH_cpu"></li>
                <li class="history" id="FL_cpu"></li>
                <li class="history" id="SR_cpu"></li>
                <li class="history" id="TK_cpu"></li>
                <li class="history" id="TP_cpu"></li>
                <li class="history" id="OP_cpu"></li>
              </ul>
            </div>
            <div>
              <input
                type="button"
                value="Reset"
                id="reset-chart-btn"
                onclick="window.location.reload();"
              />
            </div>
          </div>
          <div class="card card_you_1">
            <div class="card_front">
              <img src="./img/cards/back.png" alt="" class="you_img_1" />
            </div>
            <div class="card_back">
              <img src="" alt="" class="you_img_1" />
            </div>
          </div>
          <div class="card card_you_2">
            <div class="card_front">
              <img src="./img/cards/back.png" alt="" class="you_img_2" />
            </div>
            <div class="card_back">
              <img src="" alt="" class="you_img_2" />
            </div>
          </div>
          <div id="chat">
            <div>
              <div id="output" style="overflow: auto; height: 300px"></div>
              <div>
                <input id="text" value="メッセージを入力してください"></input>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id="indicator">
        <div id="pat_hand">
          <div id="your_result"></div>
          <div id="show_vs"></div>
          <div id="rival_result"></div>
        </div>
        <div id="win_lose">
          <div></div>
        </div>
      </div>
      <div id="controler">
        <div id="controler-btn">
          <div id="call">
            <button class="step1">すすめる</button>
          </div>
          <div id="fold">
            <button class="step1" onclick="window.location.reload();">
              やめる
            </button>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script type="module">
    //
    // sessionStorageから情報取得
    //
    let ss_th_number = JSON.parse(sessionStorage.getItem("TH_number"));
    console.log(ss_th_number);

    //
    // グローバル変数定義
    //
    // sessionStorageからテーブル番号取得
    let table_id = ss_th_number.table_id;
    // sessionStorageからユーザー番号取得
    let user_id = ss_th_number.order_player;
    // sessionStorageからユーザー数取得（最大値）
    let num_players = ss_th_number.max_player;
    let cpu_id;
    for (let i = 0; i < num_players; i++) {
      if (i != user_id) {
        cpu_id = i;
      }
    }

    let card;
    let hole_cards;
    let com_cards;
    let strength;
    let player_strength;
    let result;
    let player_num_strong;
    let com_card1;
    let com_card2;
    let com_card3;
    let com_card4;
    let com_card5;
    let vis_card;
    let cpu_card;

    //
    // Firebase定義
    //
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.8.1/firebase-app.js";
    import {
      getDatabase,
      ref,
      push,
      set,
      onChildAdded,
      remove,
      onChildRemoved,
      onChildChanged,
    } from "https://www.gstatic.com/firebasejs/9.8.1/firebase-database.js";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAJTAoocmRo7J8yBmuFS17pFl4JirW4jNs",
      authDomain: "texasholdem-afd55.firebaseapp.com",
      projectId: "texasholdem-afd55",
      storageBucket: "texasholdem-afd55.appspot.com",
      messagingSenderId: "326627407513",
      appId: "1:326627407513:web:070aac25625a093a066a08",
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const parent_dbRef = ref(db, "texasholdem/table" + table_id);
    const tb_dbRef = ref(db, "texasholdem/table" + table_id + "/table");
    const ch_dbRef = ref(db, "texasholdem/table" + table_id + "/chat");

    //
    //
    main(table_id, user_id, num_players);

    // $("#chart-btn").on("click", function () {
    //   $("#chart_block").slideToggle();
    //   if ($("#chart_block").hasClass("chart-btn_open") == false) {
    //     $("#chart_block").addClass("chart-btn_open");
    //     $("#chart-btn").attr("value", "Open");
    //   } else {
    //     $("#chart_block").removeClass("chart-btn_open");
    //     $("#chart-btn").attr("value", "Close");
    //   }
    // });

    // $("#reset-chart-btn").on("click", function () {
    //   localStorage.removeItem("TexasHoldEm");
    //   initializeChart();
    //   reloadChart();
    // });

    async function main(table_id, user_id, num_players) {
      let table = {
        phase: 0,
        table_id: table_id,
        num_player: num_players,
        hole_cards: [],
        com_cards: [],
        strength: [],
        pattern: [],
        result: [],
      };
      let flg_dealer;
      if (user_id % num_players == 0) {
        flg_dealer = true;
      }
      if (flg_dealer == true) {
        [
          card,
          hole_cards,
          com_cards,
          player_strength,
          result,
          player_num_strong,
        ] = initialize(num_players);
        // ここで全データを保存
        // 以降のデータ形式をdbのものに調整
        table.hole_cards = hole_cards;
        table.com_cards = com_cards;
        table.strength = player_strength;
        table.pattern = showStrongPattern(player_num_strong[result]);
        table.result = result;
        await set(tb_dbRef, table);
      }

      // 以降ではユーザーごとに表示を判定
      //フェーズのフラグ（*num_players）
      // $("#call>button").on("click", function () {
      //   // phase進行
      // });

      // onChildAdded(tb_dbRef, function (data) {
      //   table = data.val();
      //   if (table.phase == 0 && flg_dealer % num_players == 0) {
      //     // 親の処理実行
      //   }
      // });
      // onChildAdded(tb_dbRef, function (data) {
      //   table = data.val();
      //   if (table.phase == 0 && flg_dealer % num_players != 0) {
      //     // 子の処理実行
      //   }
      // });
      // onChildAdded(tb_dbRef, function (data) {
      //   table = data.val();
      //   if (table.phase == 0) {
      //     // 共通処理
      //   }
      // });

      // game start
      $("#call>button").on("click", function () {
        console.log("click");
        if (table.phase == 0 && user_id % num_players == 0) {
          console.log("phase: " + table.phase);
          console.log("phase proceeded");
          table.phase++; // phase:1
          set(tb_dbRef, table);
        } else if (table.phase == 1 && user_id % num_players == 0) {
          console.log("phase: " + table.phase);
          console.log("phase proceeded");
          table.phase++; // phase:2
          set(tb_dbRef, table);
        } else if (table.phase == 2 && user_id % num_players == 1) {
          console.log("phase: " + table.phase);
          console.log("phase proceeded");
          table.phase++; // phase:3
          set(tb_dbRef, table);
        } else if (table.phase == 3 && user_id % num_players == 0) {
          console.log("phase: " + table.phase);
          console.log("phase proceeded");
          table.phase++; // phase:4
          set(tb_dbRef, table);
        } else if (table.phase == 4 && user_id % num_players == 1) {
          console.log("phase: " + table.phase);
          console.log("phase proceeded");
          table.phase++; // phase:5
          set(tb_dbRef, table);
        } else if (table.phase == 5 && user_id % num_players == 0) {
          console.log("phase: " + table.phase);
          console.log("phase proceeded");
          table.phase++; // phase:6
          set(tb_dbRef, table);
        } else if (table.phase == 6 && user_id % num_players == 1) {
          console.log("phase: " + table.phase);
          console.log("phase proceeded");
          table.phase++; // phase:7
          set(tb_dbRef, table);
        } else if (table.phase == 7 && user_id % num_players == 0) {
          console.log("phase: " + table.phase);
          console.log("phase proceeded");
          table.phase++; // phase:8
          set(tb_dbRef, table);
        } else if (table.phase == 8 && user_id % num_players == 1) {
          console.log("phase: " + table.phase);
          console.log("phase proceeded");
          table.phase++; // phase:9
          set(tb_dbRef, table);
        } else if (table.phase == 9) {
          table.phase = -1; // phase:9
          set(tb_dbRef, table);
        }
      });
      onChildChanged(parent_dbRef, function (data) {
        table = data.val();
        console.log("data changed");
        if (table.phase == 1) {
          // TODO: 人数増えた場合、修正の必要あり

          com_card1 = table.com_cards[0];
          com_card2 = table.com_cards[1];
          com_card3 = table.com_cards[2];
          com_card4 = table.com_cards[3];
          com_card5 = table.com_cards[4];

          for (let i = 0; i < num_players; i++) {
            if (i == user_id) {
              vis_card = table.hole_cards.slice(i * 2, i * 2 + 2);
            } else {
              // TODO: 人数増えた場合、修正の必要あり
              cpu_card = table.hole_cards.slice(i * 2, i * 2 + 2);
            }
          }
          // prefrop
          // 共通処理
          $(".you_img_1").css("display", "none");
          $(".you_img_1").slideDown(500, function () {});
          $(".you_img_2").css("display", "none");
          $(".you_img_2").slideDown(500, function () {});

          $(".card_cpu>.card_back>.cpu_img_1").attr(
            "src",
            "./img/cards/" + visualiseCard(cpu_card[0])
          );
          $(".card_cpu>.card_back>.cpu_img_2").attr(
            "src",
            "./img/cards/" + visualiseCard(cpu_card[1])
          );
          $(".cpu_img_1").css("display", "none");
          $(".cpu_img_1").slideDown(500, function () {});
          $(".cpu_img_2").css("display", "none");
          $(".cpu_img_2").slideDown(500, function () {});

          setTimeout(function () {
            $(".card_frop>.card_back>.com_img_1").attr(
              "src",
              "./img/cards/" + visualiseCard(com_card1)
            );
            $(".card_frop>.card_back>.com_img_2").attr(
              "src",
              "./img/cards/" + visualiseCard(com_card2)
            );
            $(".card_frop>.card_back>.com_img_3").attr(
              "src",
              "./img/cards/" + visualiseCard(com_card3)
            );

            $(".card_back>.you_img_1").attr(
              "src",
              "./img/cards/" + visualiseCard(vis_card[0])
            );
            $(".card_back>.you_img_2").attr(
              "src",
              "./img/cards/" + visualiseCard(vis_card[1])
            );

            $(".card_you_1>.card_back").css("transform", "rotateY(0)");
            $(".card_you_2>.card_back").css("transform", "rotateY(0)");
            $(".card_you_1>.card_front").css("transform", "rotateY(-180deg)");
            $(".card_you_2>.card_front").css("transform", "rotateY(-180deg)");
            solvePossibility();
          }, 1000);
        } else if (table.phase == 3) {
          // frop
          $(".com_img_1").slideDown(500, function () {});
          $(".com_img_2").slideDown(500, function () {});
          $(".com_img_3").slideDown(500, function () {});
          setTimeout(function () {
            $(".card_frop>.card_back>.com_img_1").attr(
              "src",
              "./img/cards/" + visualiseCard(com_card1)
            );
            $(".card_frop>.card_back>.com_img_2").attr(
              "src",
              "./img/cards/" + visualiseCard(com_card2)
            );
            $(".card_frop>.card_back>.com_img_3").attr(
              "src",
              "./img/cards/" + visualiseCard(com_card3)
            );
            $(".card_frop>.card_back").css("transform", "rotateY(0)");
            $(".card_frop>.card_front").css("transform", "rotateY(-180deg)");
            solvePossibility();
          }, 1000);
        } else if (table.phase == 5) {
          // turn
          $(".com_img_4").slideDown(500, function () {});
          setTimeout(function () {
            $(".card_turn>.card_back>.com_img_4").attr(
              "src",
              "./img/cards/" + visualiseCard(com_card4)
            );
            $(".card_turn>.card_back").css("transform", "rotateY(0)");
            $(".card_turn>.card_front").css("transform", "rotateY(-180deg)");
            solvePossibility();
          }, 1000);
        } else if (table.phase == 7) {
          // river
          $(".com_img_5").slideDown(500, function () {});
          setTimeout(function () {
            $(".card_river>.card_back>.com_img_5").attr(
              "src",
              "./img/cards/" + visualiseCard(com_card5)
            );
            $(".card_river>.card_back").css("transform", "rotateY(0)");
            $(".card_river>.card_front").css("transform", "rotateY(-180deg)");
            solvePossibility();
          }, 1000);
        } else if (table.phase == 9) {
          // result
          $(".card_cpu>.card_back").css("transform", "rotateY(0)");
          $(".card_cpu>.card_front").css("transform", "rotateY(-180deg)");
          setTimeout(function () {
            $("#your_result").html(table.strength[user_id][3]);
            $("#show_vs").html("vs");
            $("#rival_result").html(table.strength[cpu_id][3]);
            if (table.result == user_id) {
              $("#win_lose").html("YOU WIN");
              $("#win_lose").css("color", "red");
              $("#win_lose").css("font-size", "20px");
              $("#win_lose").css("font-weight", "bold");
              $("#your_result").css("color", "red");
              $("#your_result").css("font-size", "20px");
              $("#your_result").css("font-weight", "bold");
            } else if (table.result == -1) {
              $("#win_lose").html("EVEN");
            } else {
              $("#win_lose").html("YOU LOSE");
              $("#win_lose").css("color", "red");
              $("#win_lose").css("font-size", "20px");
              $("#win_lose").css("font-weight", "bold");
              $("#rival_result").css("color", "red");
              $("#rival_result").css("font-size", "20px");
              $("#rival_result").css("font-weight", "bold");
            }
            let blink_id =
              "#" + blinkResult(table.result, table.strength);
            $(blink_id).addClass("blink_result");
            moveUseCard(table.pattern, table.result);
            $("#call>button").attr("onclick", "window.location.reload();");

            saveLocalstorage(table.strength, table.result);
          }, 1000);
        } else if (table.phase == -1) {
          window.location.reload();
        }
      });
    }

    function initialize(num_players) {
      initializeChart();
      reloadChart();
      let card = [];
      let hole_cards = [];
      // let cof = true;

      // game
      // pregame
      // カード配る
      // 乱数
      let num_cards = num_players * 2 + 5;
      const max_num_cards = 52;

      let used = [];
      let com_cards = [];

      // TODO: 2ペア時のキッカーが不十分のため修正の必要あり
      let strength = [-1, -1, -1, ""];
      let player_strength = [];
      let player_num_strong = [];

      used = durstenfeld(used, max_num_cards, num_cards);
      hole_cards = getHoleCards(hole_cards, num_players, used);
      com_cards = getComCards(com_cards, num_cards, num_players, used);

      // console.log(hole_cards);
      // console.log(com_cards);

      card = card.concat(hole_cards);
      card = card.concat(com_cards);
      // console.log("card");
      // console.log(card);

      // hands
      // 10通り Combination 5/3 =10
      let combination_hands = [];
      let num_strong = 0;
      // your hand
      for (let i = 0; i < num_players; i++) {
        combination_hands = combinationComCards(
          hole_cards,
          com_cards,
          num_players,
          i
        );
        [strength, num_strong] = selfJudge(
          combination_hands,
          num_strong,
          strength,
          i
        );
        player_strength.push(strength);
        player_num_strong.push(num_strong);
      }

      // 2名以上になる場合注意
      let result;
      result = vsJudge(player_strength, 0, 1);
      // console.log(player_num_strong[0]);
      // console.log(player_num_strong[1]);
      // console.log(result);

      return [
        card,
        hole_cards,
        com_cards,
        player_strength,
        result,
        player_num_strong,
      ];
    }

    function saveLocalstorage(player_strength, result) {
      let hit_key;
      let key_name;
      switch (result) {
        case 0:
          break;
        case 1:
          break;
        default:
          break;
      }
      switch (player_strength[0][0]) {
        case 0:
          hit_key = "HC_you";
          plusOneOnLocalstorage(hit_key);
          rewriteChart(hit_key);
          break;
        case 1:
          hit_key = "OP_you";
          plusOneOnLocalstorage(hit_key);
          rewriteChart(hit_key);
          break;
        case 2:
          hit_key = "TP_you";
          plusOneOnLocalstorage(hit_key);
          rewriteChart(hit_key);
          break;
        case 3:
          hit_key = "TK_you";
          plusOneOnLocalstorage(hit_key);
          rewriteChart(hit_key);
          break;
        case 4:
          hit_key = "SR_you";
          plusOneOnLocalstorage(hit_key);
          rewriteChart(hit_key);
          break;
        case 5:
          hit_key = "FL_you";
          plusOneOnLocalstorage(hit_key);
          rewriteChart(hit_key);
          break;
        case 6:
          hit_key = "FH_you";
          plusOneOnLocalstorage(hit_key);
          rewriteChart(hit_key);
          break;
        case 7:
          hit_key = "FK_you";
          plusOneOnLocalstorage(hit_key);
          rewriteChart(hit_key);
          break;
        case 8:
          hit_key = "SF_you";
          plusOneOnLocalstorage(hit_key);
          rewriteChart(hit_key);
          break;
        default:
          break;
      }
      switch (player_strength[1][0]) {
        case 0:
          hit_key = "HC_cpu";
          plusOneOnLocalstorage(hit_key);
          rewriteChart(hit_key);
          break;
        case 1:
          hit_key = "OP_cpu";
          plusOneOnLocalstorage(hit_key);
          rewriteChart(hit_key);
          break;
        case 2:
          hit_key = "TP_cpu";
          plusOneOnLocalstorage(hit_key);
          rewriteChart(hit_key);
          break;
        case 3:
          hit_key = "TK_cpu";
          plusOneOnLocalstorage(hit_key);
          rewriteChart(hit_key);
          break;
        case 4:
          hit_key = "SR_cpu";
          plusOneOnLocalstorage(hit_key);
          rewriteChart(hit_key);
          break;
        case 5:
          hit_key = "FL_cpu";
          plusOneOnLocalstorage(hit_key);
          rewriteChart(hit_key);
          break;
        case 6:
          hit_key = "FH_cpu";
          plusOneOnLocalstorage(hit_key);
          rewriteChart(hit_key);
          break;
        case 7:
          hit_key = "FK_cpu";
          plusOneOnLocalstorage(hit_key);
          rewriteChart(hit_key);
          break;
        case 8:
          hit_key = "SF_cpu";
          plusOneOnLocalstorage(hit_key);
          rewriteChart(hit_key);
          break;
        default:
          break;
      }
    }

    function rewriteChart(hit_key) {
      let key_name = "#" + hit_key;
      const json_chart = JSON.parse(localStorage.getItem("TexasHoldEm"));
      $(key_name).html(json_chart[hit_key]);
    }

    function initializeChart() {
      if (!localStorage.getItem("TexasHoldEm")) {
        const json_chart = {
          SF_you: 0,
          SF_you: 0,
          FK_you: 0,
          FH_you: 0,
          FL_you: 0,
          SR_you: 0,
          TK_you: 0,
          TP_you: 0,
          OP_you: 0,
          SF_cpu: 0,
          FK_cpu: 0,
          FH_cpu: 0,
          FL_cpu: 0,
          SR_cpu: 0,
          TK_cpu: 0,
          TP_cpu: 0,
          OP_cpu: 0,
        };
        const jsonString = JSON.stringify(json_chart);
        localStorage.setItem("TexasHoldEm", jsonString);
      }
    }

    function reloadChart() {
      const json_chart = JSON.parse(localStorage.getItem("TexasHoldEm"));
      $("#SF_you").html(json_chart["SF_you"]);
      $("#FK_you").html(json_chart["FK_you"]);
      $("#FH_you").html(json_chart["FH_you"]);
      $("#FL_you").html(json_chart["FL_you"]);
      $("#SR_you").html(json_chart["SR_you"]);
      $("#TK_you").html(json_chart["TK_you"]);
      $("#TP_you").html(json_chart["TP_you"]);
      $("#OP_you").html(json_chart["OP_you"]);

      $("#SF_cpu").html(json_chart["SF_cpu"]);
      $("#FK_cpu").html(json_chart["FK_cpu"]);
      $("#FH_cpu").html(json_chart["FH_cpu"]);
      $("#FL_cpu").html(json_chart["FL_cpu"]);
      $("#SR_cpu").html(json_chart["SR_cpu"]);
      $("#TK_cpu").html(json_chart["TK_cpu"]);
      $("#TP_cpu").html(json_chart["TP_cpu"]);
      $("#OP_cpu").html(json_chart["OP_cpu"]);
    }

    function plusOneOnLocalstorage(hit_key) {
      const json_chart = JSON.parse(localStorage.getItem("TexasHoldEm"));
      if (json_chart[hit_key] == null) {
        json_chart[hit_key] = 1;
      } else {
        json_chart[hit_key]++;
      }
      // setItem
      const jsonString = JSON.stringify(json_chart);
      localStorage.setItem("TexasHoldEm", jsonString);
    }

    // 組み合わせ生成アルゴリズム：ダステンフェルド法（FY法の改良版）
    function durstenfeld(used, max_num_cards, num_cards) {
      used = [];
      let array = [];
      for (let i = 0; i < max_num_cards; i++) {
        array.push(i);
      }
      for (let j = 0; j < num_cards; j++) {
        let index_card = Math.ceil(Math.random() * (max_num_cards - j)) - 1;
        used.push(array[index_card]);
        array.splice(index_card, 1);
      }
      return used;
    }

    function getCard(index) {
      let mark = index % 4;
      let number = index % 13;
      let card = [mark, number];
      return card;
    }

    function getHoleCards(hole_cards, num_players, used) {
      for (let i = 0; i < num_players; i++) {
        let tmp_1 = getCard(used[i * 2]);
        let tmp_2 = getCard(used[i * 2 + 1]);
        hole_cards.push(tmp_1);
        hole_cards.push(tmp_2);
      }
      return hole_cards;
    }

    function getComCards(com_cards, num_cards, num_players, used) {
      for (let i = 0; i < num_cards - num_players * 2; i++) {
        com_cards.push(getCard(used[i + num_players * 2]));
      }
      return com_cards;
    }

    //
    function solvePossibility() {}

    function blinkResult(result, player_strength) {
      if (result != -1) {
        let id_factor = player_strength[result][0];
        if (id_factor == 1) {
          return "OP";
        } else if (id_factor == 2) {
          return "TP";
        } else if (id_factor == 3) {
          return "TK";
        } else if (id_factor == 4) {
          return "SR";
        } else if (id_factor == 5) {
          return "FL";
        } else if (id_factor == 6) {
          return "FH";
        } else if (id_factor == 7) {
          return "FK";
        } else if (id_factor == 8) {
          return "SF";
        }
      }
    }

    function moveUseCard(pattern, player) {
      let pattern_strong = pattern[player_num_strong[player]];
      $(".card>div").css("position", "absolute");
      $(".card>div").css("top", "0");
      $(".card>div").css("left", "0");
      if (player == -1) {
        console.log("EVEN");
      } else {
        for (let i = 0; i < pattern_strong.length; i++) {
          if (pattern_strong[i] == 0) {
            if (player == 0) {
              $(".card_you_1>.card_back").animate({ top: "-30px" }, 500);
              // console.log("0-0");
            } else if (player == 1) {
              $(".card_cpu_1>.card_back").animate({ top: "30px" }, 500);
              // console.log("0-1");
            }
          } else if (pattern_strong[i] == 1) {
            if (player == 0) {
              $(".card_you_2>.card_back").animate({ top: "-30px" }, 500);
              // console.log("1-0");
            } else if (player == 1) {
              // console.log("1-1");
              $(".card_cpu_2>.card_back").animate({ top: "30px" }, 500);
            }
          } else if (pattern_strong[i] == 2) {
            if (player == 0) {
              // console.log("2-0");
              $(".card_com_1>.card_back").animate({ top: "30px" }, 500);
            } else if (player == 1) {
              // console.log("2-1");
              $(".card_com_1>.card_back").animate({ top: "-30px" }, 500);
            }
          } else if (pattern_strong[i] == 3) {
            if (player == 0) {
              // console.log("3-0");
              $(".card_com_2>.card_back").animate({ top: "30px" }, 500);
            } else if (player == 1) {
              // console.log("3-1");
              $(".card_com_2>.card_back").animate({ top: "-30px" }, 500);
            }
          } else if (pattern_strong[i] == 4) {
            if (player == 0) {
              // console.log("4-0");
              $(".card_com_3>.card_back").animate({ top: "30px" }, 500);
            } else if (player == 1) {
              // console.log("4-1");
              $(".card_com_3>.card_back").animate({ top: "-30px" }, 500);
            }
          } else if (pattern_strong[i] == 5) {
            if (player == 0) {
              // console.log("5-0");
              $(".card_com_4>.card_back").animate({ top: "30px" }, 500);
            } else if (player == 1) {
              // console.log("5-1");
              $(".card_com_4>.card_back").animate({ top: "-30px" }, 500);
            }
          } else if (pattern_strong[i] == 6) {
            if (player == 0) {
              // console.log("6-0");
              $(".card_com_5>.card_back").animate({ top: "30px" }, 500);
            } else if (player == 1) {
              $(".card_com_5>.card_back").animate({ top: "-30px" }, 500);
              // console.log("6-1");
            }
          }
        }
      }
    }

    function showStrongPattern(num_strong) {
      const tmp = [0, 1, 2, 3, 4, 5, 6];
      let pattern_card_num = combination(tmp, 5);
      return pattern_card_num;
    }

    function visualiseCard(card) {
      let mark;
      let number;
      if (card[0] == 0) {
        mark = "s";
      } else if (card[0] == 1) {
        mark = "h";
      } else if (card[0] == 2) {
        mark = "c";
      } else if (card[0] == 3) {
        mark = "d";
      }
      number = card[1] + 1;
      let name_img = mark + ("00" + number).slice(-2) + ".png";
      // console.log(name_img);
      return name_img;
    }

    function vsJudge(player_strength, player1, player2) {
      let player1_strength;
      player1_strength = player_strength[player1];
      let player2_strength;
      player2_strength = player_strength[player2];
      // console.log(player1_strength);
      // console.log(player2_strength);
      if (player1_strength[0] < player2_strength[0]) {
        return 1;
      } else if (player1_strength[0] == player2_strength[0]) {
        if (player1_strength[1] < player2_strength[1]) {
          return 1;
        } else if (player1_strength[1] == player2_strength[1]) {
          if (player1_strength[2] < player2_strength[2]) {
            return 1;
          } else if (player1_strength[2] == player2_strength[2]) {
            return -1;
          } else {
            return 0;
          }
        } else {
          return 0;
        }
      } else {
        return 0;
      }
    }

    function selfJudge(combination_hands, num_strong, strength, player) {
      let ex_strength = [-1, -1, -1, ""];
      num_strong = 0;
      strength = [-1, -1, -1, ""];
      // console.log("combination_hands.length");
      // console.log(combination_hands.length);
      for (let i = 0; i < combination_hands.length; i++) {
        ex_strength = strength;
        strength = judgeHands(combination_hands[i]);
        // console.log(strength);
        if (ex_strength[0] < strength[0]) {
          num_strong = i;
        } else if (ex_strength[0] == strength[0]) {
          if (ex_strength[1] < strength[1]) {
            num_strong = i;
          } else if (ex_strength[1] == strength[1]) {
            if (ex_strength[2] < strength[2]) {
              num_strong = i;
            } else {
              strength = ex_strength;
            }
          } else {
            strength = ex_strength;
          }
        } else {
          strength = ex_strength;
        }
      }
      return [strength, num_strong];
    }

    // for 人数分

    // 最強ハンド検索（self judge）

    // vs judge

    // list:communty cards(n=5), k:number of combination (n=3)
    function combinationComCards(hole_cards, com_cards, num_players, player) {
      let whole_cards = [];
      whole_cards.push(hole_cards[player * 2]);
      whole_cards.push(hole_cards[player * 2 + 1]);
      for (let k = 0; k < com_cards.length; k++) {
        whole_cards.push(com_cards[k]);
      }
      // console.log("hole_cards");
      // console.log(hole_cards);
      // console.log("whole_cards");
      // console.log(whole_cards);
      let combination_hands = [];
      combination_hands = combination(whole_cards, 5);
      // console.log("combination_hands");
      // console.log(combination_hands);
      // for (let i = 0; i<21; i++){
      //   for (let l = 0; l<5; l++){
      //   }
      // }
      return combination_hands;
    }

    function combination(nums, k) {
      let ans = [];
      // console.log(nums.length);
      if (nums.length < k) {
        return [];
      }
      if (k === 1) {
        for (let i = 0; i < nums.length; i++) {
          ans[i] = [nums[i]];
        }
      } else {
        for (let i = 0; i < nums.length - k + 1; i++) {
          let row = combination(nums.slice(i + 1), k - 1);
          for (let j = 0; j < row.length; j++) {
            ans.push([nums[i]].concat(row[j]));
          }
        }
      }
      return ans;
    }

    //
    // チャット
    //

    //データ登録(Enter)
    $("#text").on("keydown", function (e) {
      console.log(e); //e変数の中身を確認！！
      if (e.keyCode == 13) {
        //EnterKey=13
        const msg = {
          uname: "user_id: " + user_id,
          text: $("#text").val(),
        };
        const newPostRef = push(ch_dbRef); //ユニークKEYを生成
        set(newPostRef, msg); //"chat"にユニークKEYをつけてオブジェクトデータを登録
      }
    });

    //最初にデータ取得＆onSnapshotでリアルタイムにデータを取得
    onChildAdded(ch_dbRef, function (data) {
      const msg = data.val(); //オブジェクトデータを取得し、変数msgに代入
      const key = data.key; //データのユニークキー（削除や更新に使用可能）
      //表示用テキスト・HTMLを作成
      let h = "<p>";
      h += msg.uname;
      h += "<br>";
      h += msg.text;
      h += "</p>";
      $("#output").append(h); //#outputの最後に追加
      scrollToEnd()
    });

    function scrollToEnd() {
      const messagesArea = document.getElementById('output');
      messagesArea.scrollTop = messagesArea.scrollHeight;
    } 
  </script>
</html>

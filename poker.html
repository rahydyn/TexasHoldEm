<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./css/style.css" />
    <script src="./js/jquery-2.1.3.min.js"></script>
    <title>TH</title>
  </head>
  <body>
    <header>
      <div id="header"><span>ヘッダー</span></div>
    </header>
    <div id="container">
      <div id="player2" class="player">
        <div class="hand">
          <div class="card card_player2 card_player2_1">
            <div class="card_front">
              <img src="./img/cards/back.png" alt="" class="player2_img_1" />
            </div>
            <div class="card_back">
              <img src="" alt class="player2_img_1" />
            </div>
          </div>
          <div class="card card_player2 card_player2_2">
            <div class="card_front">
              <img src="./img/cards/back.png" alt="" class="player2_img_2" />
            </div>
            <div class="card_back">
              <img src="" alt class="player2_img_2" />
            </div>
          </div>
        </div>
      </div>
      <div id="com_card" class="player">
        <div class="hand">
          <div class="card card_frop card_com_1">
            <div class="card_front">
              <img src="./img/cards/back.png" alt="" class="com_img_1" />
            </div>
            <div class="card_back">
              <img src="" alt="" class="com_img_1" />
            </div>
          </div>
          <div class="card card_frop card_com_2">
            <div class="card_front">
              <img src="./img/cards/back.png" alt="" class="com_img_2" />
            </div>
            <div class="card_back">
              <img src="" alt="" class="com_img_2" />
            </div>
          </div>
          <div class="card card_frop card_com_3">
            <div class="card_front">
              <img src="./img/cards/back.png" alt="" class="com_img_3" />
            </div>
            <div class="card_back">
              <img src="" alt="" class="com_img_3" />
            </div>
          </div>
          <div class="card card_turn card_com_4">
            <div class="card_front">
              <img src="./img/cards/back.png" alt="" class="com_img_4" />
            </div>
            <div class="card_back">
              <img src="" alt="" class="com_img_4" />
            </div>
          </div>
          <div class="card card_river card_com_5">
            <div class="card_front">
              <img src="./img/cards/back.png" alt="" class="com_img_5" />
            </div>
            <div class="card_back">
              <img src="" alt="" class="com_img_5" />
            </div>
          </div>
        </div>
      </div>
      <div id="player1" class="player">
        <div class="hand">
          <div class="card card_player1_1">
            <div class="card_front">
              <img src="./img/cards/back.png" alt="" class="player1_img_1" />
            </div>
            <div class="card_back">
              <img src="" alt="" class="player1_img_1" />
            </div>
          </div>
          <div class="card card_player1_2">
            <div class="card_front">
              <img src="./img/cards/back.png" alt="" class="player1_img_2" />
            </div>
            <div class="card_back">
              <img src="" alt="" class="player1_img_2" />
            </div>
          </div>
          <div id="chart">
            <div>
              <input type="button" value="Close" id="chart-btn" />
            </div>
            <div id="chart_block">
              <ul id="chart_list">
                <li class="strength chart_list_title">役一覧</li>
                <li class="strength" id="SF">Straight Flush</li>
                <li class="strength" id="FK">Four-of-a-Kind</li>
                <li class="strength" id="FH">Full House</li>
                <li class="strength" id="FL">Flush</li>
                <li class="strength" id="SR">Straight</li>
                <li class="strength" id="TK">Three-of-a-Kind</li>
                <li class="strength" id="TP">Two-Pair</li>
                <li class="strength" id="OP">One-Pair</li>
              </ul>
              <ul id="your_history">
                <li class="history chart_list_title">You</li>
                <li class="history" id="SF_player1"></li>
                <li class="history" id="FK_player1"></li>
                <li class="history" id="FH_player1"></li>
                <li class="history" id="FL_player1"></li>
                <li class="history" id="SR_player1"></li>
                <li class="history" id="TK_player1"></li>
                <li class="history" id="TP_player1"></li>
                <li class="history" id="OP_player1"></li>
              </ul>
              <ul id="cpu_history">
                <li class="history chart_list_title">Rival</li>
                <li class="history" id="SF_player2"></li>
                <li class="history" id="FK_player2"></li>
                <li class="history" id="FH_player2"></li>
                <li class="history" id="FL_player2"></li>
                <li class="history" id="SR_player2"></li>
                <li class="history" id="TK_player2"></li>
                <li class="history" id="TP_player2"></li>
                <li class="history" id="OP_player2"></li>
              </ul>
            </div>
            <div>
              <input type="button" value="Reset" id="reset-chart-btn" />
            </div>
          </div>
        </div>
      </div>
      <div id="indicator">
        <div id="pat_hand">
          <div id="your_result"></div>
          <div id="show_vs"></div>
          <div id="rival_result"></div>
        </div>
        <div id="win_lose">
          <div></div>
        </div>
      </div>
      <div id="controler">
        <div id="controler-btn">
          <div id="call">
            <button class="step1">すすめる</button>
          </div>
          <div id="fold">
            <button class="step1" onclick="window.location.reload();">
              やめる
            </button>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script>
    main();

    $("#chart-btn").on("click", function () {
      $("#chart_block").slideToggle();
      if ($("#chart_block").hasClass("chart-btn_open") == false) {
        $("#chart_block").addClass("chart-btn_open");
        $("#chart-btn").attr("value", "Open");
      } else {
        $("#chart_block").removeClass("chart-btn_open");
        $("#chart-btn").attr("value", "Close");
      }
    });

    $("#reset-chart-btn").on("click", function () {
      localStorage.removeItem("TexasHoldEm");
      initializeChart();
      reloadChart();
    });

    function main() {
      [
        cpu_card,
        com_cards,
        vis_card,
        player_strength,
        result,
        player_num_strong,
      ] = initialize();
      let com_card1 = com_cards[0];
      let com_card2 = com_cards[1];
      let com_card3 = com_cards[2];
      let com_card4 = com_cards[3];
      let com_card5 = com_cards[4];
      $("#call>button").on("click", function () {
        if ($(this).hasClass("step1") == true) {
          $(".player1_img_1").css("display", "none");
          $(".player1_img_1").slideDown(500, function () {});
          $(".player1_img_2").css("display", "none");
          $(".player1_img_2").slideDown(500, function () {});
          $(".card_player2>.card_back>.player2_img_1").attr(
            "src",
            "./img/cards/" + visualiseCard(cpu_card[0])
          );
          $(".card_player2>.card_back>.player2_img_2").attr(
            "src",
            "./img/cards/" + visualiseCard(cpu_card[1])
          );

          $(".player2_img_1").css("display", "none");
          $(".player2_img_1").slideDown(500, function () {});
          $(".player2_img_2").css("display", "none");
          $(".player2_img_2").slideDown(500, function () {});
          setTimeout(function () {
            $(".card_frop>.card_back>.com_img_1").attr(
              "src",
              "./img/cards/" + visualiseCard(com_card1)
            );
            $(".card_frop>.card_back>.com_img_2").attr(
              "src",
              "./img/cards/" + visualiseCard(com_card2)
            );
            $(".card_frop>.card_back>.com_img_3").attr(
              "src",
              "./img/cards/" + visualiseCard(com_card3)
            );
            $(".card_back>.player1_img_1").attr(
              "src",
              "./img/cards/" + visualiseCard(vis_card[0])
            );

            $(".card_back>.player1_img_2").attr(
              "src",
              "./img/cards/" + visualiseCard(vis_card[1])
            );
            $(".card_player1_1>.card_back").css("transform", "rotateY(0)");
            $(".card_player1_2>.card_back").css("transform", "rotateY(0)");
            $(".card_player1_1>.card_front").css(
              "transform",
              "rotateY(-180deg)"
            );
            $(".card_player1_2>.card_front").css(
              "transform",
              "rotateY(-180deg)"
            );
            solvePossibility();
          }, 1000);

          $(this).addClass("step2");
          $(this).removeClass("step1");
        } else if ($(this).hasClass("step2") == true) {
          $(".com_img_1").slideDown(500, function () {});
          $(".com_img_2").slideDown(500, function () {});
          $(".com_img_3").slideDown(500, function () {});
          setTimeout(function () {
            $(".card_frop>.card_back>.com_img_1").attr(
              "src",
              "./img/cards/" + visualiseCard(com_card1)
            );
            $(".card_frop>.card_back>.com_img_2").attr(
              "src",
              "./img/cards/" + visualiseCard(com_card2)
            );
            $(".card_frop>.card_back>.com_img_3").attr(
              "src",
              "./img/cards/" + visualiseCard(com_card3)
            );
            $(".card_frop>.card_back").css("transform", "rotateY(0)");
            $(".card_frop>.card_front").css("transform", "rotateY(-180deg)");
            solvePossibility();
          }, 1000);
          $(this).addClass("step3");
          $(this).removeClass("step2");
        } else if ($(this).hasClass("step3") == true) {
          $(".com_img_4").slideDown(500, function () {});
          setTimeout(function () {
            $(".card_turn>.card_back>.com_img_4").attr(
              "src",
              "./img/cards/" + visualiseCard(com_card4)
            );
            $(".card_turn>.card_back").css("transform", "rotateY(0)");
            $(".card_turn>.card_front").css("transform", "rotateY(-180deg)");
            solvePossibility();
          }, 1000);
          $(this).addClass("step4");
          $(this).removeClass("step3");
        } else if ($(this).hasClass("step4") == true) {
          $(".com_img_5").slideDown(500, function () {});
          setTimeout(function () {
            $(".card_river>.card_back>.com_img_5").attr(
              "src",
              "./img/cards/" + visualiseCard(com_card5)
            );
            $(".card_river>.card_back").css("transform", "rotateY(0)");
            $(".card_river>.card_front").css("transform", "rotateY(-180deg)");
            solvePossibility();
          }, 1000);
          $(this).addClass("step5");
          $(this).removeClass("step4");
        } else if ($(this).hasClass("step5") == true) {
          $(this).removeClass("step5");
          $(".card_player2>.card_back").css("transform", "rotateY(0)");
          $(".card_player2>.card_front").css("transform", "rotateY(-180deg)");
          setTimeout(function () {
            $("#your_result").html(player_strength[0][3]);
            $("#show_vs").html("vs");
            $("#rival_result").html(player_strength[1][3]);
            if (result == 0) {
              $("#win_lose").html("YOU WIN");
              $("#win_lose").css("color", "red");
              $("#win_lose").css("font-size", "20px");
              $("#win_lose").css("font-weight", "bold");
              $("#your_result").css("color", "red");
              $("#your_result").css("font-size", "20px");
              $("#your_result").css("font-weight", "bold");
            } else if (result == -1) {
              $("#win_lose").html("EVEN");
            } else {
              $("#win_lose").html("YOU LOSE");
              $("#win_lose").css("color", "red");
              $("#win_lose").css("font-size", "20px");
              $("#win_lose").css("font-weight", "bold");
              $("#rival_result").css("color", "red");
              $("#rival_result").css("font-size", "20px");
              $("#rival_result").css("font-weight", "bold");
            }
            let blink_id = "#" + blinkResult(result, player_strength);
            $(blink_id).addClass("blink_result");
            let pattern = showStrongPattern(player_num_strong[result]);
            moveUseCard(pattern, result);
            $("#call>button").attr("onclick", "window.location.reload();");

            saveLocalstorage(player_strength, result);
          }, 1000);

          for (let i = 0; i < player_strength.length; i++) {
            console.log(player_strength[i]);
          }
        }
      });
    }

    function initialize(num_players) {
      initializeChart();
      reloadChart();
      let card = [];
      let hole_cards = [];
      // let cof = true;

      // game
      // pregame
      // カード配る
      // 乱数
      num_players = 2; //1on1
      let num_cards = 5 + num_players * 2;
      const max_num_cards = 52;

      let used = [];
      let com_cards = [];

      // TODO: 2ペア時のキッカーが不十分のため修正の必要あり
      let strength = [-1, -1, -1, ""];
      let player_strength = [];
      let player_num_strong = [];

      used = durstenfeld(used, max_num_cards, num_cards);
      hole_cards = getHoleCards(hole_cards, num_players, used);
      com_cards = getComCards(com_cards, num_cards, num_players, used);

      // prefrop
      // TODO: 人数増えた場合、修正の必要あり
      let vis_card = hole_cards.slice(0, 2);
      let cpu_card = hole_cards.slice(2, 4);

      // frop
      // 3枚配る

      console.log(com_cards);
      // ベットアクション（コールorフォールド）
      // turn
      // 1枚配る
      // ベットアクション（コールorフォールド）
      // river
      // 1枚配る

      // ベットアクション（コールorフォールド）

      console.log("------------used------------");
      console.log(used);
      console.log("------------used------------");
      // console.log(strength);

      // hands
      // 10通り Combination 5/3 =10
      let combination_hands = [];
      let num_strong = 0;
      // your hand
      combination_hands = combinationComCards(
        hole_cards,
        com_cards,
        num_players,
        0
      );
      [strength, num_strong] = selfJudge(
        combination_hands,
        num_strong,
        strength,
        0
      );
      player_strength.push(strength);
      player_num_strong.push(num_strong);

      // rival hand
      combination_hands = combinationComCards(
        hole_cards,
        com_cards,
        num_players,
        1
      );
      [strength, num_strong] = selfJudge(
        combination_hands,
        num_strong,
        strength,
        1
      );
      player_strength.push(strength);
      player_num_strong.push(num_strong);

      let result;
      result = vsJudge(player_strength);
      console.log(player_num_strong[0]);
      console.log(player_num_strong[1]);
      console.log(result);

      return [
        cpu_card,
        com_cards,
        vis_card,
        player_strength,
        result,
        player_num_strong,
      ];
    }

    function saveLocalstorage(player_strength, result) {
      let hit_key;
      let key_name;
      switch (result) {
        case 0:
          break;
        case 1:
          break;
        default:
          break;
      }
      switch (player_strength[0][0]) {
        case 0:
          hit_key = "HC_player1";
          plusOneOnLocalstorage(hit_key);
          rewriteChart(hit_key);
          break;
        case 1:
          hit_key = "OP_player1";
          plusOneOnLocalstorage(hit_key);
          rewriteChart(hit_key);
          break;
        case 2:
          hit_key = "TP_player1";
          plusOneOnLocalstorage(hit_key);
          rewriteChart(hit_key);
          break;
        case 3:
          hit_key = "TK_player1";
          plusOneOnLocalstorage(hit_key);
          rewriteChart(hit_key);
          break;
        case 4:
          hit_key = "SR_player1";
          plusOneOnLocalstorage(hit_key);
          rewriteChart(hit_key);
          break;
        case 5:
          hit_key = "FL_player1";
          plusOneOnLocalstorage(hit_key);
          rewriteChart(hit_key);
          break;
        case 6:
          hit_key = "FH_player1";
          plusOneOnLocalstorage(hit_key);
          rewriteChart(hit_key);
          break;
        case 7:
          hit_key = "FK_player1";
          plusOneOnLocalstorage(hit_key);
          rewriteChart(hit_key);
          break;
        case 8:
          hit_key = "SF_player1";
          plusOneOnLocalstorage(hit_key);
          rewriteChart(hit_key);
          break;
        default:
          break;
      }
      switch (player_strength[1][0]) {
        case 0:
          hit_key = "HC_player2";
          plusOneOnLocalstorage(hit_key);
          rewriteChart(hit_key);
          break;
        case 1:
          hit_key = "OP_player2";
          plusOneOnLocalstorage(hit_key);
          rewriteChart(hit_key);
          break;
        case 2:
          hit_key = "TP_player2";
          plusOneOnLocalstorage(hit_key);
          rewriteChart(hit_key);
          break;
        case 3:
          hit_key = "TK_player2";
          plusOneOnLocalstorage(hit_key);
          rewriteChart(hit_key);
          break;
        case 4:
          hit_key = "SR_player2";
          plusOneOnLocalstorage(hit_key);
          rewriteChart(hit_key);
          break;
        case 5:
          hit_key = "FL_player2";
          plusOneOnLocalstorage(hit_key);
          rewriteChart(hit_key);
          break;
        case 6:
          hit_key = "FH_player2";
          plusOneOnLocalstorage(hit_key);
          rewriteChart(hit_key);
          break;
        case 7:
          hit_key = "FK_player2";
          plusOneOnLocalstorage(hit_key);
          rewriteChart(hit_key);
          break;
        case 8:
          hit_key = "SF_player2";
          plusOneOnLocalstorage(hit_key);
          rewriteChart(hit_key);
          break;
        default:
          break;
      }
    }

    function rewriteChart(hit_key) {
      let key_name = "#" + hit_key;
      const json_chart = JSON.parse(localStorage.getItem("TexasHoldEm"));
      $(key_name).html(json_chart[hit_key]);
    }

    function initializeChart() {
      if (!localStorage.getItem("TexasHoldEm")) {
        const json_chart = {
          SF_player1: 0,
          SF_player1: 0,
          FK_player1: 0,
          FH_player1: 0,
          FL_player1: 0,
          SR_player1: 0,
          TK_player1: 0,
          TP_player1: 0,
          OP_player1: 0,
          SF_player2: 0,
          FK_player2: 0,
          FH_player2: 0,
          FL_player2: 0,
          SR_player2: 0,
          TK_player2: 0,
          TP_player2: 0,
          OP_player2: 0,
        };
        const jsonString = JSON.stringify(json_chart);
        localStorage.setItem("TexasHoldEm", jsonString);
      }
    }

    function reloadChart() {
      const json_chart = JSON.parse(localStorage.getItem("TexasHoldEm"));
      $("#SF_player1").html(json_chart["SF_player1"]);
      $("#FK_player1").html(json_chart["FK_player1"]);
      $("#FH_player1").html(json_chart["FH_player1"]);
      $("#FL_player1").html(json_chart["FL_player1"]);
      $("#SR_player1").html(json_chart["SR_player1"]);
      $("#TK_player1").html(json_chart["TK_player1"]);
      $("#TP_player1").html(json_chart["TP_player1"]);
      $("#OP_player1").html(json_chart["OP_player1"]);

      $("#SF_player2").html(json_chart["SF_player2"]);
      $("#FK_player2").html(json_chart["FK_player2"]);
      $("#FH_player2").html(json_chart["FH_player2"]);
      $("#FL_player2").html(json_chart["FL_player2"]);
      $("#SR_player2").html(json_chart["SR_player2"]);
      $("#TK_player2").html(json_chart["TK_player2"]);
      $("#TP_player2").html(json_chart["TP_player2"]);
      $("#OP_player2").html(json_chart["OP_player2"]);
    }

    function plusOneOnLocalstorage(hit_key) {
      const json_chart = JSON.parse(localStorage.getItem("TexasHoldEm"));
      if (json_chart[hit_key] == null) {
        json_chart[hit_key] = 1;
      } else {
        json_chart[hit_key]++;
      }
      // setItem
      const jsonString = JSON.stringify(json_chart);
      localStorage.setItem("TexasHoldEm", jsonString);
    }

    // 組み合わせ生成アルゴリズム：ダステンフェルド法（FY法の改良版）
    function durstenfeld(used, max_num_cards, num_cards) {
      used = [];
      let array = [];
      for (let i = 0; i < max_num_cards; i++) {
        array.push(i);
      }
      for (let j = 0; j < num_cards; j++) {
        let index_card = Math.ceil(Math.random() * (max_num_cards - j)) - 1;
        used.push(array[index_card]);
        array.splice(index_card, 1);
      }
      return used;
    }

    function getCard(index) {
      let mark = index % 4;
      let number = index % 13;
      let card = [mark, number];
      return card;
    }

    function getHoleCards(hole_cards, num_players, used) {
      for (let i = 0; i < num_players; i++) {
        let tmp_1 = getCard(used[i * 2]);
        let tmp_2 = getCard(used[i * 2 + 1]);
        hole_cards.push(tmp_1);
        hole_cards.push(tmp_2);
      }
      return hole_cards;
    }

    function getComCards(com_cards, num_cards, num_players, used) {
      for (let i = 0; i < num_cards - num_players * 2; i++) {
        com_cards.push(getCard(used[i + num_players * 2]));
      }
      return com_cards;
    }

    //
    function solvePossibility() {}

    function blinkResult(result, player_strength) {
      if (result != -1) {
        let id_factor = player_strength[result][0];
        if (id_factor == 1) {
          return "OP";
        } else if (id_factor == 2) {
          return "TP";
        } else if (id_factor == 3) {
          return "TK";
        } else if (id_factor == 4) {
          return "SR";
        } else if (id_factor == 5) {
          return "FL";
        } else if (id_factor == 6) {
          return "FH";
        } else if (id_factor == 7) {
          return "FK";
        } else if (id_factor == 8) {
          return "SF";
        }
      }
    }

    function moveUseCard(pattern, player) {
      let pattern_strong = pattern[player_num_strong[player]];
      $(".card>div").css("position", "absolute");
      $(".card>div").css("top", "0");
      $(".card>div").css("left", "0");
      if (player == -1) {
        console.log("EVEN");
      } else {
        for (let i = 0; i < pattern_strong.length; i++) {
          if (pattern_strong[i] == 0) {
            if (player == 0) {
              $(".card_player1_1>.card_back").animate({ top: "-30px" }, 500);
              console.log("0-0");
            } else if (player == 1) {
              $(".card_player2_1>.card_back").animate({ top: "30px" }, 500);
              console.log("0-1");
            }
          } else if (pattern_strong[i] == 1) {
            if (player == 0) {
              $(".card_player1_2>.card_back").animate({ top: "-30px" }, 500);
              console.log("1-0");
            } else if (player == 1) {
              console.log("1-1");
              $(".card_player2_2>.card_back").animate({ top: "30px" }, 500);
            }
          } else if (pattern_strong[i] == 2) {
            if (player == 0) {
              console.log("2-0");
              $(".card_com_1>.card_back").animate({ top: "30px" }, 500);
            } else if (player == 1) {
              console.log("2-1");
              $(".card_com_1>.card_back").animate({ top: "-30px" }, 500);
            }
          } else if (pattern_strong[i] == 3) {
            if (player == 0) {
              console.log("3-0");
              $(".card_com_2>.card_back").animate({ top: "30px" }, 500);
            } else if (player == 1) {
              console.log("3-1");
              $(".card_com_2>.card_back").animate({ top: "-30px" }, 500);
            }
          } else if (pattern_strong[i] == 4) {
            if (player == 0) {
              console.log("4-0");
              $(".card_com_3>.card_back").animate({ top: "30px" }, 500);
            } else if (player == 1) {
              console.log("4-1");
              $(".card_com_3>.card_back").animate({ top: "-30px" }, 500);
            }
          } else if (pattern_strong[i] == 5) {
            if (player == 0) {
              console.log("5-0");
              $(".card_com_4>.card_back").animate({ top: "30px" }, 500);
            } else if (player == 1) {
              console.log("5-1");
              $(".card_com_4>.card_back").animate({ top: "-30px" }, 500);
            }
          } else if (pattern_strong[i] == 6) {
            if (player == 0) {
              console.log("6-0");
              $(".card_com_5>.card_back").animate({ top: "30px" }, 500);
            } else if (player == 1) {
              $(".card_com_5>.card_back").animate({ top: "-30px" }, 500);
              console.log("6-1");
            }
          }
        }
      }
    }

    function showStrongPattern(num_strong) {
      const tmp = [0, 1, 2, 3, 4, 5, 6];
      let pattern_card_num = combination(tmp, 5);
      return pattern_card_num;
    }

    function visualiseCard(card) {
      let mark;
      let number;
      if (card[0] == 0) {
        mark = "s";
      } else if (card[0] == 1) {
        mark = "h";
      } else if (card[0] == 2) {
        mark = "c";
      } else if (card[0] == 3) {
        mark = "d";
      }
      number = card[1] + 1;
      let name_img = mark + ("00" + number).slice(-2) + ".png";
      // console.log(name_img);
      return name_img;
    }

    function vsJudge(player_strength) {
      let player1_strength;
      player1_strength = player_strength[0];
      let player2_strength;
      player2_strength = player_strength[1];
      // console.log(player1_strength);
      // console.log(player2_strength);
      if (player1_strength[0] < player2_strength[0]) {
        return 1;
      } else if (player1_strength[0] == player2_strength[0]) {
        if (player1_strength[1] < player2_strength[1]) {
          return 1;
        } else if (player1_strength[1] == player2_strength[1]) {
          if (player1_strength[2] < player2_strength[2]) {
            return 1;
          } else if (player1_strength[2] == player2_strength[2]) {
            return -1;
          } else {
            return 0;
          }
        } else {
          return 0;
        }
      } else {
        return 0;
      }
    }

    function selfJudge(combination_hands, num_strong, strength, player) {
      let ex_strength = [-1, -1, -1, ""];
      num_strong = 0;
      strength = [-1, -1, -1, ""];
      // console.log("combination_hands.length");
      // console.log(combination_hands.length);
      for (let i = 0; i < combination_hands.length; i++) {
        ex_strength = strength;
        strength = judgeHands(combination_hands[i]);
        // console.log(strength);
        if (ex_strength[0] < strength[0]) {
          num_strong = i;
        } else if (ex_strength[0] == strength[0]) {
          if (ex_strength[1] < strength[1]) {
            num_strong = i;
          } else if (ex_strength[1] == strength[1]) {
            if (ex_strength[2] < strength[2]) {
              num_strong = i;
            } else {
              strength = ex_strength;
            }
          } else {
            strength = ex_strength;
          }
        } else {
          strength = ex_strength;
        }
      }
      return [strength, num_strong];
    }

    // for 人数分

    // 最強ハンド検索（self judge）

    // vs judge

    // list:communty cards(n=5), k:number of combination (n=3)
    function combinationComCards(hole_cards, com_cards, num_players, player) {
      let whole_cards = [];
      whole_cards.push(hole_cards[player * 2]);
      whole_cards.push(hole_cards[player * 2 + 1]);
      for (let k = 0; k < com_cards.length; k++) {
        whole_cards.push(com_cards[k]);
      }
      // console.log("hole_cards");
      // console.log(hole_cards);
      // console.log("whole_cards");
      // console.log(whole_cards);
      let combination_hands = [];
      combination_hands = combination(whole_cards, 5);
      // console.log("combination_hands");
      // console.log(combination_hands);
      // for (let i = 0; i<21; i++){
      //   for (let l = 0; l<5; l++){
      //   }
      // }
      return combination_hands;
    }

    function combination(nums, k) {
      let ans = [];
      // console.log(nums.length);
      if (nums.length < k) {
        return [];
      }
      if (k === 1) {
        for (let i = 0; i < nums.length; i++) {
          ans[i] = [nums[i]];
        }
      } else {
        for (let i = 0; i < nums.length - k + 1; i++) {
          let row = combination(nums.slice(i + 1), k - 1);
          for (let j = 0; j < row.length; j++) {
            ans.push([nums[i]].concat(row[j]));
          }
        }
      }
      return ans;
    }

    // functions for judgement
    function judgeHands(hand) {
      let strength = [-1, -1, -1];
      let flush = -1;
      let straight = -1;
      let num_pair1 = -1;
      let num_pair2 = -1;
      let threeofakinds = -1;
      let fourofakinds = -1;
      let kicker = -1;

      flush = isFlush(hand);
      straight = isStraight(hand);
      [num_pair1, num_pair2, threeofakinds, fourofakinds, kicker] =
        cntPairs(hand);
      // straightflush
      if (flush >= 0 && straight >= 0) {
        strength[0] = 8;
        strength[1] = flush;
        strength[3] = "Straight Flush";
        return strength;
      }
      // fourofakinds
      if (fourofakinds >= 0) {
        strength[0] = 7;
        strength[1] = fourofakinds;
        strength[2] = kicker;
        strength[3] = "Four-of-a-Kind";
        return strength;
      }
      // fullhouse
      if (threeofakinds >= 0 && num_pair1 >= 0) {
        strength[0] = 6;
        strength[1] = threeofakinds;
        strength[2] = num_pair1;
        strength[3] = "Full House";
        return strength;
      }
      // flush
      if (flush >= 0) {
        strength[0] = 5;
        strength[1] = flush;
        strength[3] = "Flush";
        return strength;
      }
      // straight
      if (straight >= 0 && num_pair1 == -1 && threeofakinds == -1) {
        strength[0] = 4;
        strength[1] = straight;
        strength[3] = "Straight";
        return strength;
      }
      // threeofakinds
      if (threeofakinds >= 0) {
        strength[0] = 3;
        strength[1] = threeofakinds;
        strength[2] = kicker;
        strength[3] = "Three-of-a-Kind";
        return strength;
      }
      // twopairs
      if (num_pair2 >= 0) {
        strength[0] = 2;
        strength[1] = num_pair2;
        strength[2] = num_pair1;
        strength[3] = "Two-Pair";
        return strength;
      }
      // onepair
      if (num_pair1 >= 0) {
        strength[0] = 1;
        strength[1] = num_pair1;
        strength[2] = kicker;
        strength[3] = "One-Pair";
        return strength;
      }
      // highcard
      strength[0] = 0;
      strength[1] = kicker;
      strength[3] = "High Card";
      return strength;
    }

    function isFlush(hand) {
      let flush = -1;
      if (
        hand[1][0] == hand[2][0] &&
        hand[2][0] == hand[3][0] &&
        hand[3][0] == hand[4][0] &&
        hand[4][0] == hand[0][0]
      ) {
        let max = Math.max.apply(
          null,
          hand.map((item) => item[1])
        );
        let min = Math.min.apply(
          null,
          hand.map((item) => item[1])
        );
        if (min == 0) {
          flush = 13;
        } else {
          flush = max;
        }
      }
      return flush;
    }

    function isStraight(hand) {
      let straight = -1;
      let max = Math.max.apply(
        null,
        hand.map((item) => item[1])
      );
      let min = Math.min.apply(
        null,
        hand.map((item) => item[1])
      );
      let diff = max - min;
      if (diff == 4) {
        straight = max;
      } else if (diff == 12) {
        let min2 = hand
          .map((item) => item[1])
          .sort(function (a, b) {
            return a - b;
          })[1];
        if (max - min2 == 3) {
          straight = 13;
        }
      }
      return straight;
    }

    function cntPairs(hand) {
      let num_pair1 = -1;
      let num_pair2 = -1;
      let threeofakinds = -1;
      let fourofakinds = -1;
      let kicker = -1;
      let count = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
      for (let k = 0; k < 13; k++) {
        for (let i = 0; i < 5; i++) {
          if (hand[i][1] == k) {
            count[k] += 1;
          }
        }
      }
      // console.log(count);
      // pair
      let pair_flg = 0;
      for (let j = 0; j < 13; j++) {
        if (pair_flg == 0) {
          if (count[j] == 2) {
            if (j == 0) {
              num_pair1 = 13;
            } else {
              num_pair1 = j;
            }
            pair_flg = 1;
          }
        } else if (pair_flg == 1) {
          if (count[j] == 2) {
            num_pair2 = j;
            if (num_pair1 == 13) {
              num_pair2 = 13;
              num_pair1 = j;
            }
          }
        }
        if (count[j] == 3) {
          if (j == 0) {
            threeofakinds = 13;
          } else {
            threeofakinds = j;
          }
        }
        if (count[j] == 4) {
          if (j == 0) {
            fourofakinds = 13;
          } else {
            fourofakinds = j;
          }
        }
        if (count[j] == 1) {
          kicker = j;
        }
      }
      if (count[0] == 1) {
        kicker = 13;
      }
      return [num_pair1, num_pair2, threeofakinds, fourofakinds, kicker];
    }
  </script>
</html>
